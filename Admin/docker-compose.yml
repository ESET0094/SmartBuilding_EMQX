version: '3.8'

services:
  localhost:
    image: emqx/emqx:5.4.1
    container_name: localhost
    # Use the service name as the internal hostname for consistency
    hostname: localhost 
    environment:
      # Use the local service name in the node name
      - "EMQX_ALLOW_ANONYMOUS=false"
      - "EMQX_NODE__NAME=localhost@localhost"
      # IMPORTANT: Remove leading space from cookie value
      - "EMQX_NODE__COOKIE=secretcookie" 
      - "EMQX_CLUSTER__DISCOVERY_STRATEGY=static"
      - "EMQX_AUTH__USER__1__USERNAME=Admin"
      - "EMQX_AUTH__USER__1__PASSWORD=Public"
      - "EMQX_AUTHORIZATION__CACHE__ENABLE=true"
      - "EMQX_AUTHORIZATION__ACL__FILE=/opt/emqx/etc/acl.conf"
      # List all seed nodes using their service names/hostnames
      # We use 'localhost' and 'emqx2' which Docker's internal DNS will resolve
      # - "EMQX_CLUSTER__STATIC__SEEDS=[\"localhost@localhost\",\"emqx2@emqx2\"]"
   
    ports: 
      - "18081:18083" # Dashboard
      - "8081:8083"   # MQTT/WS
      - "1881:1883"   # MQTT/TCP
      - "8881:8883"   # MQTT/WSS
      # Exposing port 4370 for EPMD (Erlang Port Mapper Daemon) is often helpful for clustering debug
      - "4370:4370"
    volumes:
      - ./acl.conf:/opt/emqx/etc/acl.conf

#   emqx2:
#     image: emqx/emqx:5.4.1
#     container_name: emqx2
#     # Use the service name as the internal hostname for consistency
#     hostname: emqx2 
#     environment:
#       # Use the local service name in the node name
#       - "EMQX_NODE__NAME=emqx2@emqx2"
#       # IMPORTANT: Must match localhost's cookie value exactly
#       - "EMQX_NODE__COOKIE=secretcookie"
#       - "EMQX_CLUSTER__DISCOVERY_STRATEGY=static"
#       # List all seed nodes using their service names/hostnames
#       - "EMQX_CLUSTER__STATIC__SEEDS=[\"localhost@localhost\",\"emqx2@emqx2\"]"
#     networks:
#       emqx-net:
#         aliases:
#           - emqx2.local
#     ports: 
#       # Mapped to different host ports to avoid conflicts
#       - "18082:18083" # Dashboard (Host 18082)
#       - "8085:8083"   # MQTT/WS (Host 8085)
#       - "2884:1883"   # MQTT/TCP (Host 2884)
#       - "8885:8883"   # MQTT/WSS (Host 8885)
  
#   haproxy:
#     image: haproxy:latest
#     container_name: haproxy
#     ports:
#       - "1883:1883"    # MQTT (Single entry point via HAProxy)
#       - "8080:8080"    # HAProxy stats UI
#     volumes:
#       # Ensure you have the haproxy.cfg file in the same directory as your docker-compose file
#       - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
#     depends_on:
#       - localhost
#       - emqx2
#     networks:
#       - emqx-net

# # Top-level definition for the custom bridge network
# networks:
#   emqx-net:
#     driver: bridge
